import os
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from selenium.common.exceptions import WebDriverException
from urllib.parse import urlparse

class ScreenshotTaker:
    def __init__(self, chrome_driver_path="/usr/bin/chromedriver"):
        self.browser = self.setup_browser(chrome_driver_path)

    def setup_browser(self, chrome_driver_path):
        options = Options()
        options.add_argument("--headless")  # Ensure headless mode is activated
        options.add_argument("--no-sandbox")  # Bypass OS security model, required in some environments
        options.add_argument("--disable-gpu")  # Disable GPU hardware acceleration, if necessary
        options.add_argument("--disable-dev-shm-usage")  # Overcome limited resource problems
        service = Service(executable_path=chrome_driver_path)
        return webdriver.Chrome(service=service, options=options)

    def take_screenshot(self, url, save_dir="images"):
        try:
            os.makedirs(save_dir, exist_ok=True)
            self.browser.get(url)
            page_name = self.format_page_name(url)
            screenshot_file = os.path.join(save_dir, f"{page_name}.png")
            self.browser.save_screenshot(screenshot_file)
        except WebDriverException as e:
            print(f"Error taking screenshot of {url}: {e}")
        except Exception as e:
            print(f"Unexpected error: {e}")
        finally:
            self.browser.quit()

    def format_page_name(self, url):
        page_name = urlparse(url).path.replace('/', '_').strip('_')
        return page_name if page_name else 'index'
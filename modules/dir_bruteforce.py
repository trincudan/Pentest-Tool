import asyncio
import aiohttp
from urllib.parse import urljoin
from datetime import datetime
from rich.console import Console
from rich.progress import Progress, BarColumn, TextColumn
from rich.table import Table
from rich.layout import Layout
from rich.live import Live
from .logger import setup_logger
from .screenshotter import ScreenshotTaker

logger = setup_logger()
screenshot_taker = ScreenshotTaker("/usr/bin/chromedriver")

async def check_url(session, base_url, path, semaphore, found_paths, timeout):
    url = urljoin(base_url, path)
    try:
        async with semaphore:
            async with session.get(url, timeout=timeout) as response:
                if response.ok:  # Check if response is OK
                    return url, str(response.status)
    except asyncio.TimeoutError:
        logger.warning(f"Timeout error for URL: {url}")
    except Exception as e:
        logger.error(f"Error for URL {url}: {e}")
    return None, None

async def brute_force_directories(target_url, wordlist_path, max_concurrent_requests=128, timeout=2):
    start_time = datetime.now()

    wordlist = load_wordlist(wordlist_path)
    found_paths = set()

    console = Console()
    progress = Progress(TextColumn("[bold blue]{task.description}"), BarColumn(), TextColumn("{task.completed} of {task.total}"), console=console)
    task = progress.add_task("Brute-forcing...", total=len(wordlist))
    
    table = create_table()

    layout = Layout()
    layout.split_column(Layout(name="table"), Layout(name="progress"))
    layout["table"].update(table)
    layout["progress"].update(progress)

    async with aiohttp.ClientSession() as session:
        semaphore = asyncio.Semaphore(max_concurrent_requests)
        tasks = [check_url(session, target_url, word, semaphore, found_paths, timeout) for word in wordlist]

        with Live(layout, console=console, refresh_per_second=10):
            for future in asyncio.as_completed(tasks):
                url, status = await future
                if url and status:
                    if url not in found_paths:
                        found_paths.add(url)
                        table.add_row(url, status)
                        screenshot_taker.take_screenshot(url)
                progress.update(task, advance=1)

    end_time = datetime.now()
    console.print(f"\nTotal time taken: {end_time - start_time}")

def load_wordlist(file_path):
    with open(file_path, 'r') as file:
        # Using a generator to handle large wordlists efficiently
        return [line.strip() for line in file if not line.startswith('#') and line.strip() != ""]

def create_table():
    table = Table(show_header=True, header_style="bold green")
    table.add_column("Paths Found", justify="left")
    table.add_column("Status Code", justify="center")
    return table
